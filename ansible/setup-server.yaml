- name: Deploy s3up-server
  hosts: all
  gather_facts: false

  pre_tasks:
    - name: Build server binary
      command: go build -o dist/s3up-server-linux ./cmd/server
      args:
        chdir: "{{ playbook_dir }}/../apps/uploader"
      environment:
        CGO_ENABLED: "0"
        GOOS: linux
        GOARCH: amd64
      delegate_to: localhost

    - name: Lookup S3 credentials
      set_fact:
        s3_creds: "{{ lookup('pipe', 'rpass get personal/s3uploader/s3_credentials') | from_json }}"
      delegate_to: localhost

    - name: Set S3 vars
      set_fact:
        s3_access_key_id: "{{ s3_creds.aws_access_key_id }}"
        s3_secret_access_key: "{{ s3_creds.aws_secret_access_key }}"
        s3_region: "{{ s3_creds.region }}"
        s3_endpoint: "{{ s3_creds.endpoint }}"
      delegate_to: localhost

    - name: Resolve client entries
      set_fact:
        client_entries: "{{ lookup('pipe', 'python3 ' + playbook_dir + '/resolve_client_entries.py') | from_json }}"
      delegate_to: localhost

  tasks:
    - name: Create app directory
      file:
        path: "{{ s3uploader_dir }}"
        state: directory
        mode: "0755"

    - name: Copy server binary
      copy:
        src: ../apps/uploader/dist/s3up-server-linux
        dest: "{{ s3uploader_dir }}/s3up-server"
        mode: "0755"
      notify: restart s3uploader-server

    - name: Template server config
      template:
        src: templates/server.yaml.j2
        dest: "{{ s3uploader_dir }}/server.yaml"
        mode: "0600"
      notify: restart s3uploader-server

    - name: Template clients config
      template:
        src: templates/clients.yaml.j2
        dest: "{{ s3uploader_dir }}/clients.yaml"
        mode: "0600"

    - name: Create systemd user directory
      file:
        path: ~/.config/systemd/user
        state: directory
        mode: "0755"

    - name: Template systemd unit
      template:
        src: templates/s3uploader-server.service.j2
        dest: ~/.config/systemd/user/s3uploader-server.service
        mode: "0644"
      notify: restart s3uploader-server

    - name: Enable linger for user
      command: loginctl enable-linger {{ ansible_user }}
      become: true
      changed_when: false

    - name: Reload systemd user daemon
      systemd:
        daemon_reload: true
        scope: user

    - name: Enable service
      systemd:
        name: s3uploader-server
        enabled: true
        scope: user

  handlers:
    - name: restart s3uploader-server
      systemd:
        name: s3uploader-server
        state: restarted
        scope: user
